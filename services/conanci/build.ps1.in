function ThrowOnNonZero {
    if (-not $$?)
    {
        throw 'Last command failed'
    }
}

echo '### Setup SSH ###'
mkdir -p "$$env:userprofile\.ssh"; ThrowOnNonZero
Copy-Item "C:\id_rsa" -Destination "$$env:userprofile\.ssh"; ThrowOnNonZero
Copy-Item C:\known_hosts -Destination "$$env:userprofile\.ssh"; ThrowOnNonZero

echo '### Setup Conan ###'
echo '# Clean remotes'
conan remote clean; ThrowOnNonZero

echo '# Add Conan server'
conan remote add server $conan_remote; ThrowOnNonZero

echo '# Setup Conan user'
conan user -r server -p $conan_password $conan_user; ThrowOnNonZero

echo '# Enable Conan revisions'
conan config set general.revisions_enabled=1; ThrowOnNonZero

echo '### Clone repository ###'
mkdir conanci; ThrowOnNonZero
cd conanci; ThrowOnNonZero
git init; ThrowOnNonZero
git remote add origin $git_url; ThrowOnNonZero
git fetch origin $git_sha; ThrowOnNonZero
git checkout FETCH_HEAD; ThrowOnNonZero

echo '### Build package ###'
$$package_name=[string](conan inspect --raw name $path); ThrowOnNonZero
$$package_version=[string](conan inspect --raw version $path); ThrowOnNonZero
conan create $path @$conanci_user/$channel; ThrowOnNonZero
conan upload $$package_name/$$package_version@$conanci_user/$channel --all --confirm -r server; ThrowOnNonZero